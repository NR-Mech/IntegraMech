DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'mech') THEN
        CREATE SCHEMA mech;
    END IF;
END $EF$;


CREATE TABLE mech.departamentos (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    nome text NOT NULL,
    descricao text NOT NULL,
    CONSTRAINT pk_departamentos PRIMARY KEY (id)
);


CREATE TABLE mech.especialidades (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    nome text NOT NULL,
    CONSTRAINT pk_especialidades PRIMARY KEY (id)
);


CREATE TABLE mech.estados (
    id text NOT NULL,
    nome text NOT NULL,
    CONSTRAINT pk_estados PRIMARY KEY (id)
);


CREATE TABLE mech.generos (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    nome text NOT NULL,
    CONSTRAINT pk_generos PRIMARY KEY (id)
);


CREATE TABLE mech.medicos (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    nome text NOT NULL,
    crm text NOT NULL,
    CONSTRAINT pk_medicos PRIMARY KEY (id)
);


CREATE TABLE mech.tipos_de_quarto (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    nome text NOT NULL,
    CONSTRAINT pk_tipos_de_quarto PRIMARY KEY (id)
);


CREATE TABLE mech.triagens (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    sexo text,
    idade integer,
    forma_de_chegada integer,
    lesao boolean,
    queixa text,
    estado_mental integer,
    dor boolean,
    enf_dor smallint,
    disposicao integer,
    classificacao integer,
    sbs numeric,
    dbp numeric,
    bc numeric,
    fr numeric,
    tc numeric,
    CONSTRAINT pk_triagens PRIMARY KEY (id)
);


CREATE TABLE mech.cidades (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    estado_id text NOT NULL,
    nome text NOT NULL,
    CONSTRAINT pk_cidades PRIMARY KEY (id),
    CONSTRAINT fk_cidades_estado_estado_id FOREIGN KEY (estado_id) REFERENCES mech.estados (id) ON DELETE CASCADE
);


CREATE TABLE mech.departamentos__medicos (
    departamento_id bigint NOT NULL,
    medico_id bigint NOT NULL,
    CONSTRAINT pk_departamentos__medicos PRIMARY KEY (departamento_id, medico_id),
    CONSTRAINT fk_departamentos__medicos_departamentos_departamento_id FOREIGN KEY (departamento_id) REFERENCES mech.departamentos (id) ON DELETE CASCADE,
    CONSTRAINT fk_departamentos__medicos_medicos_medico_id FOREIGN KEY (medico_id) REFERENCES mech.medicos (id) ON DELETE CASCADE
);


CREATE TABLE mech.medicos__especialidades (
    medico_id bigint NOT NULL,
    especialidade_id bigint NOT NULL,
    CONSTRAINT pk_medicos__especialidades PRIMARY KEY (medico_id, especialidade_id),
    CONSTRAINT fk_medicos__especialidades_especialidades_especialidade_id FOREIGN KEY (especialidade_id) REFERENCES mech.especialidades (id) ON DELETE CASCADE,
    CONSTRAINT fk_medicos__especialidades_medicos_medico_id FOREIGN KEY (medico_id) REFERENCES mech.medicos (id) ON DELETE CASCADE
);


CREATE TABLE mech.quartos (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    tipo_id bigint NOT NULL,
    esta_ocupado boolean NOT NULL,
    CONSTRAINT pk_quartos PRIMARY KEY (id),
    CONSTRAINT fk_quartos_tipo_de_quarto_tipo_id FOREIGN KEY (tipo_id) REFERENCES mech.tipos_de_quarto (id) ON DELETE CASCADE
);


CREATE TABLE mech.enderecos (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    cidade_id bigint NOT NULL,
    cep text NOT NULL,
    rua text NOT NULL,
    bairro text NOT NULL,
    CONSTRAINT pk_enderecos PRIMARY KEY (id),
    CONSTRAINT fk_enderecos_cidades_cidade_id FOREIGN KEY (cidade_id) REFERENCES mech.cidades (id) ON DELETE CASCADE
);


CREATE TABLE mech.pacientes (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    genero_id bigint NOT NULL,
    endereco_id bigint NOT NULL,
    nome text NOT NULL,
    cpf text NOT NULL,
    cns text NOT NULL,
    data_de_nascimento date NOT NULL,
    CONSTRAINT pk_pacientes PRIMARY KEY (id),
    CONSTRAINT fk_pacientes_endereco_endereco_id FOREIGN KEY (endereco_id) REFERENCES mech.enderecos (id) ON DELETE CASCADE,
    CONSTRAINT fk_pacientes_generos_genero_id FOREIGN KEY (genero_id) REFERENCES mech.generos (id) ON DELETE CASCADE
);


CREATE TABLE mech.estadias (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    paciente_id bigint NOT NULL,
    medico_id bigint NOT NULL,
    quarto_id bigint NOT NULL,
    motivo_da_admissao text NOT NULL,
    data_da_admissao timestamp without time zone NOT NULL,
    data_da_alta timestamp without time zone,
    CONSTRAINT pk_estadias PRIMARY KEY (id),
    CONSTRAINT fk_estadias_medicos_medico_id FOREIGN KEY (medico_id) REFERENCES mech.medicos (id) ON DELETE CASCADE,
    CONSTRAINT fk_estadias_pacientes_paciente_id FOREIGN KEY (paciente_id) REFERENCES mech.pacientes (id) ON DELETE CASCADE,
    CONSTRAINT fk_estadias_quartos_quarto_id FOREIGN KEY (quarto_id) REFERENCES mech.quartos (id) ON DELETE CASCADE
);


INSERT INTO mech.departamentos (id, descricao, nome)
VALUES (1, 'Departamento de Urgência e Emergência', 'Urgência e Emergência');
INSERT INTO mech.departamentos (id, descricao, nome)
VALUES (2, 'Departamento de Administração', 'Administração');
INSERT INTO mech.departamentos (id, descricao, nome)
VALUES (3, 'Departamento de Recursos Humanos', 'Recursos Humanos');
INSERT INTO mech.departamentos (id, descricao, nome)
VALUES (4, 'Departamento de Apoio Terapêutico', 'Apoio Terapêutico');


INSERT INTO mech.especialidades (id, nome)
VALUES (1, 'Alergia e Imunologia');
INSERT INTO mech.especialidades (id, nome)
VALUES (2, 'Cardiologia');
INSERT INTO mech.especialidades (id, nome)
VALUES (3, 'Cirurgia Oncológica');
INSERT INTO mech.especialidades (id, nome)
VALUES (4, 'Geriatria');
INSERT INTO mech.especialidades (id, nome)
VALUES (5, 'Homeopatia');


INSERT INTO mech.estados (id, nome)
VALUES ('AC', 'Acre');
INSERT INTO mech.estados (id, nome)
VALUES ('AL', 'Alagoas');
INSERT INTO mech.estados (id, nome)
VALUES ('AM', 'Amazonas');
INSERT INTO mech.estados (id, nome)
VALUES ('AP', 'Amapá');
INSERT INTO mech.estados (id, nome)
VALUES ('BA', 'Bahia');
INSERT INTO mech.estados (id, nome)
VALUES ('CE', 'Ceará');
INSERT INTO mech.estados (id, nome)
VALUES ('DF', 'Distrito Federal');
INSERT INTO mech.estados (id, nome)
VALUES ('ES', 'Espirito Santo');
INSERT INTO mech.estados (id, nome)
VALUES ('GO', 'Goiás');
INSERT INTO mech.estados (id, nome)
VALUES ('MA', 'Maranhão');
INSERT INTO mech.estados (id, nome)
VALUES ('MG', 'Minas Gerais');
INSERT INTO mech.estados (id, nome)
VALUES ('MS', 'Mato Grosso do Sul');
INSERT INTO mech.estados (id, nome)
VALUES ('MT', 'Mato Grosso');
INSERT INTO mech.estados (id, nome)
VALUES ('PA', 'Pará');
INSERT INTO mech.estados (id, nome)
VALUES ('PB', 'Paraíba');
INSERT INTO mech.estados (id, nome)
VALUES ('PE', 'Pernambuco');
INSERT INTO mech.estados (id, nome)
VALUES ('PI', 'Piauí');
INSERT INTO mech.estados (id, nome)
VALUES ('PR', 'Paraná');
INSERT INTO mech.estados (id, nome)
VALUES ('RJ', 'Rio de Janeiro');
INSERT INTO mech.estados (id, nome)
VALUES ('RN', 'Rio Grande do Norte');
INSERT INTO mech.estados (id, nome)
VALUES ('RO', 'Rondônia');
INSERT INTO mech.estados (id, nome)
VALUES ('RR', 'Roraima');
INSERT INTO mech.estados (id, nome)
VALUES ('RS', 'Rio Grande do Sul');
INSERT INTO mech.estados (id, nome)
VALUES ('SC', 'Santa Catarina');
INSERT INTO mech.estados (id, nome)
VALUES ('SE', 'Sergipe');
INSERT INTO mech.estados (id, nome)
VALUES ('SP', 'São Paulo');
INSERT INTO mech.estados (id, nome)
VALUES ('TO', 'Tocantins');


INSERT INTO mech.generos (id, nome)
VALUES (1, 'Feminino');
INSERT INTO mech.generos (id, nome)
VALUES (2, 'Masculino');


INSERT INTO mech.medicos (id, crm, nome)
VALUES (1, '852456/SP', 'Dr. Hans Chucrutes');
INSERT INTO mech.medicos (id, crm, nome)
VALUES (2, '159753/PE', 'Dr. Chico Science');
INSERT INTO mech.medicos (id, crm, nome)
VALUES (3, '354961/RJ', 'Dr. Zeca Pagodinho');


INSERT INTO mech.tipos_de_quarto (id, nome)
VALUES (1, 'UTI');
INSERT INTO mech.tipos_de_quarto (id, nome)
VALUES (2, 'Leito Clínico');
INSERT INTO mech.tipos_de_quarto (id, nome)
VALUES (3, 'Leito Cirúrgico');


INSERT INTO mech.cidades (id, estado_id, nome)
VALUES (1, 'PE', 'Caruaru');
INSERT INTO mech.cidades (id, estado_id, nome)
VALUES (2, 'PE', 'Recife');
INSERT INTO mech.cidades (id, estado_id, nome)
VALUES (3, 'SP', 'Marília');
INSERT INTO mech.cidades (id, estado_id, nome)
VALUES (4, 'PE', 'Santa Cruz do Capibaribe');


INSERT INTO mech.departamentos__medicos (departamento_id, medico_id)
VALUES (1, 1);
INSERT INTO mech.departamentos__medicos (departamento_id, medico_id)
VALUES (1, 2);
INSERT INTO mech.departamentos__medicos (departamento_id, medico_id)
VALUES (1, 3);
INSERT INTO mech.departamentos__medicos (departamento_id, medico_id)
VALUES (2, 2);


INSERT INTO mech.medicos__especialidades (especialidade_id, medico_id)
VALUES (1, 1);
INSERT INTO mech.medicos__especialidades (especialidade_id, medico_id)
VALUES (2, 1);
INSERT INTO mech.medicos__especialidades (especialidade_id, medico_id)
VALUES (3, 1);
INSERT INTO mech.medicos__especialidades (especialidade_id, medico_id)
VALUES (4, 1);
INSERT INTO mech.medicos__especialidades (especialidade_id, medico_id)
VALUES (1, 2);
INSERT INTO mech.medicos__especialidades (especialidade_id, medico_id)
VALUES (5, 3);


INSERT INTO mech.quartos (id, esta_ocupado, tipo_id)
VALUES (1, TRUE, 1);
INSERT INTO mech.quartos (id, esta_ocupado, tipo_id)
VALUES (2, FALSE, 2);
INSERT INTO mech.quartos (id, esta_ocupado, tipo_id)
VALUES (3, TRUE, 2);
INSERT INTO mech.quartos (id, esta_ocupado, tipo_id)
VALUES (4, FALSE, 3);


INSERT INTO mech.enderecos (id, bairro, cep, cidade_id, rua)
VALUES (1, 'Centenário', '5861618', 1, 'Paulo Afonso');
INSERT INTO mech.enderecos (id, bairro, cep, cidade_id, rua)
VALUES (2, 'Janga', '6746816', 2, 'Walter de Afogados');


INSERT INTO mech.pacientes (id, cns, cpf, data_de_nascimento, endereco_id, genero_id, nome)
VALUES (1, '4684686781', '05531923023', DATE '1944-02-14', 1, 2, 'Reginaldo Rossi');
INSERT INTO mech.pacientes (id, cns, cpf, data_de_nascimento, endereco_id, genero_id, nome)
VALUES (2, '6186168168', '29328343046', DATE '1950-04-02', 2, 2, 'Faustão');
INSERT INTO mech.pacientes (id, cns, cpf, data_de_nascimento, endereco_id, genero_id, nome)
VALUES (3, '8451947367', '48993836060', DATE '1980-09-18', 2, 1, 'Raquel Dos Teclados');


INSERT INTO mech.estadias (id, data_da_admissao, data_da_alta, medico_id, motivo_da_admissao, paciente_id, quarto_id)
VALUES (1, TIMESTAMP '2024-08-15 22:12:46.878186', NULL, 1, 'Coma alcoólico / deu PT', 1, 1);
INSERT INTO mech.estadias (id, data_da_admissao, data_da_alta, medico_id, motivo_da_admissao, paciente_id, quarto_id)
VALUES (2, TIMESTAMP '2024-07-17 22:12:46.878188', TIMESTAMP '2024-08-06 22:12:46.878188', 2, 'Transplante de coração', 2, 3);


CREATE INDEX ix_cidades_estado_id ON mech.cidades (estado_id);


CREATE INDEX ix_departamentos__medicos_medico_id ON mech.departamentos__medicos (medico_id);


CREATE INDEX ix_enderecos_cidade_id ON mech.enderecos (cidade_id);


CREATE INDEX ix_estadias_medico_id ON mech.estadias (medico_id);


CREATE INDEX ix_estadias_paciente_id ON mech.estadias (paciente_id);


CREATE INDEX ix_estadias_quarto_id ON mech.estadias (quarto_id);


CREATE INDEX ix_medicos__especialidades_especialidade_id ON mech.medicos__especialidades (especialidade_id);


CREATE INDEX ix_pacientes_endereco_id ON mech.pacientes (endereco_id);


CREATE INDEX ix_pacientes_genero_id ON mech.pacientes (genero_id);


CREATE INDEX ix_quartos_tipo_id ON mech.quartos (tipo_id);


SELECT setval(
    pg_get_serial_sequence('mech.departamentos', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.departamentos) + 1,
        nextval(pg_get_serial_sequence('mech.departamentos', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('mech.especialidades', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.especialidades) + 1,
        nextval(pg_get_serial_sequence('mech.especialidades', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('mech.generos', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.generos) + 1,
        nextval(pg_get_serial_sequence('mech.generos', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('mech.medicos', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.medicos) + 1,
        nextval(pg_get_serial_sequence('mech.medicos', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('mech.tipos_de_quarto', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.tipos_de_quarto) + 1,
        nextval(pg_get_serial_sequence('mech.tipos_de_quarto', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('mech.cidades', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.cidades) + 1,
        nextval(pg_get_serial_sequence('mech.cidades', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('mech.quartos', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.quartos) + 1,
        nextval(pg_get_serial_sequence('mech.quartos', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('mech.enderecos', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.enderecos) + 1,
        nextval(pg_get_serial_sequence('mech.enderecos', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('mech.pacientes', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.pacientes) + 1,
        nextval(pg_get_serial_sequence('mech.pacientes', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('mech.estadias', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM mech.estadias) + 1,
        nextval(pg_get_serial_sequence('mech.estadias', 'id'))),
    false);


